#include"k.h" // ngn/k, (c) 2019 ngn, GNU AGPLv3 - http://bitbucket.org/ngn/k/raw/master/LICENSE
S A sl(L v)_(C b[20],*s=b;
 $(v==_0N,*s++='0';*s++='N')
 E($(v<0,v=-v;*s++='-')$(v==_0W,*s++='0';*s++='W')E(UL l=0,t=10;W(t<=(UL)v,t*=10;l++)s+=l;F(l+1,UL k=(UL)v/10,r=(UL)v%10;*s--='0'+r;v=k)s+=l+2))
 aCm(b,s))
S A sd(D v)_(C b[400],*s=b;$(v<0,v=-v;*s++='-')
 $(d2l(v)<<1>>53==-1,*s++='0';*s++=v==_0w?'w':'n')
 E(D p=1,q=10;W(q<=v,p=q;q*=10)W(p>=1,L d=(L)(v/p);v-=d*p;p/=10;*s++='0'+d)*s++='.';F(17,L d=(L)(v/p);v-=d*p;p/=10;*s++='0'+d;$(v==0,B)))
 aCm(b,s))
A1(str0,asrt(xtC);x=room(x,1);xc[xn]=0;x)
A1(str,P(xtc,enl(x))P(xts,mR(symstr(gs(x))))P(xtl,sl(gl(x)))P(xt==tdx,sd(gd(x)))P(xto,fir(AT(tX,x)))
 P(xtu||xtv,atnv(tC,1+(Av(x)>19)+xtu,(C[]){vc[Av(x)],':',':'}))P(xtt,kst(x))ea1(str,x))
#define h(x)  (y=cat(y,x))
#define hs(s) (y=catc(y,s,ZZ(s)-1))
#define hc(c) (y=apc(y,c))
#define hx(x) (y=cat(y,kst(x)))
S A kp(A x,I p)_(x=kst(x);p?apc(cat(ac('('),x),')'):x)S O C esc(C c)_(c?"tnr\"\\"[Ci("\t\n\r\"\\",c)]:'0')
S A1(kr,kp(x,                                    xtq||xtr||xtu||xtv||xtw))
S A1(kl,kp(x,xtX||xtC?xn==1:xtT?xn<=1:xtaA||     xtq||xtr||xtu||xtv||xtw))
S A1(ko,kp(x,xtX||xtC?xn==1:xtT?xn<=1:xtaA||xtp||xtq||               xtw))
A2(ks2,
 P(xtl||xt==tdx||xto||xtu||xtv,h(str(x)))
 P(xtiI,h(apc(kst(gL(x)),'i')))
 P(xtT&&xn==1,h(cat(ac(','),kr(fir(x)))))
 P(xts,x=symstr(gl(x));C*s=xc;mr(pS(&s));h(cat(ac('`'),*s?kst(xn-1?xR:ac(*xc)):xR)))
 P(xtcC,x=enla(x);I b=0,n=xn,m=n+2;F(n,C c=xci,e=esc(c);$(!C3(32,c,126)&&!e,b=1;B)m+=!!e)A z=aC(b?2+2*n:m);C*s=zc;
  $(b,*s='0';s[1]='x';s+=2;F(n,C c=xci;*s++=hex(c>>4&15);*s++=hex(c&15)))E(*s++='"';F(n,C c=esc(xci);$(c,*s++='\\';*s++=c)E(*s++=xci))*s='"')
  h(z);xr;y)
 P(xtX,h(K("{\"(\",(\";\"/`k'x),\")\"}",x)))
 P(xtS,h(K("{$[#x;,/`k'x;\"0#`\"]}",x)))
 P(xtT,h(K("{$[#x;\" \"/`k'x;(@,0n)=@x;\"0#0n\";(@,0)=@x;\"!0\";\"???\"]}",x)))
 P(xtA,h(K("{\"+\",`k@+x}",x)))
 P(xta,A z=gkv(&x);h(cat(apc(kl(x),'!'),kr(z))))
 P(xtq,h(K(",/`k'.:",x)))
 P(xtp,A z=xx;$(xn==3&&(ztv||ztr)&&xy-cv_plc&&xz==cv_plc,h(cat(kl(mR(xy)),kst(zR))))
              E(hx(zR);I i=1;W(i<xn,hc(i-1?';':'[');$(xai-cv_plc,hx(mR(xai)))i++)hc(']'))xr;y)
 P(xtr,h(cat(ko(fir(AT(tX,x))),kst(cw(Av(x))))))
 P(xtw,I v=Av(x);hc("'/\\'/\\"[v]);$(v>2,hc(':'))y)
 xr;h(aCz("???")))
A1(kst,ks2(x,aC(0)))
A1(out,A y;P(x==cu0,x)$(xtX&&xn>1,y=aCn("(",1);F(xn,$(i,hs("\n "))hx(mR(xai)))hs(")\n"))E(y=kst(xR);hc(10))yr;write(1,yc,yn);x)
