#include"a.h" // ngn/k, (c) 2019-2021 ngn, GNU AGPLv3 - https://git.sr.ht/~ngn/k/blob/master/LICENSE
A rsh_(Ax/*0*/,L m,L*pj,L*s,L r)_(Nn=absL(*s);P(r>1,Ay=aA(n);i(n,ya=rsh_(x,m,pj,s+1,r-1))y)
 Ct=tT(xt);Y(t&&!xn,x=cn[t])Lj=*s>=0?*pj:(m-n%m)%m,w=ZT[t],q=min(m-j,n);*pj=(j+n)%m;Ay=atn(t,n);mc(yC,xC+j*w,q*w);
 mc(yC+q*w,xC,min(j,n-q)*w);W(2*m<=n,mc(yC+m*w,yC,m*w);m*=2)Y(n>m,mc(yC+m*w,yC,(n-m)*w))Y(t==tA,y=sqz(mRa(y)))y)
SN A flt(Ax,Ay,Cb)_(Er(!ytT,x,y)Au=atn(yt,0);
 i(yn,Az=get(y,i);z=app(x,&z,1);Y(!z,u=u(0);BR)z=gL(z);P(!z,x(y(u(0))))Ln=gl(z);j(b?n:!n,uq(get(y,i))))x(y(u)))
A2(rsh,XF(flt(x,y,1))Ym(Xz(Az=kv(&y);xR;y=N2(x,z,rsh(x,y));z=N1(y,rsh(x,z));am(y,z))x=enla(x);xR;am(x,ap1(y,x)))
 YM(y=mut(y);yy=ear(cv('#'),A(x,yy),2);y)
 y=!ytT?enl(y):!yn?enl(fir(y)):y;x=enla(Ny(gL(x)));P(!xn,fir(x(y)))
 i(xn,Lv=xl;Y(v<0,Ed(xn>2||xn==2&&v-NL,x,y)P(xn==1&&v==NL,x(y))
  P(xn==2,Ed(*xL<=0&&xL[1]<=0||!yn,x,y)*xL==NL?K("{x@:1;(x*!1+(-x)!-1+#y)_y}",x,y):K("{x@:0;((-x)!(#y)*!x)_y}",x,y))))
 Lj=0;x(y(rsh_(y,yn,&j,xL,xn))))
A2(cut,XF(flt(x,y,0))Ym(K("{((!y)^x)#y}",x,y))
 YT(x=Ny(gL(x));K("{n:#y;y$[x~*x;$[n<x|-x;!0;x<0;!n+0^x;x+!n-x];$[|/0<':x,#y;`err\"dom\";x+!'1_-':x,#y]]}",x,y))
 Yz(Et(!xtT,x,y)Li=gl(y);P(!in(i,xn),x)
  Au=atn(xt,xn-1);L w=ZT[xt];mc(uC,xC,i*w);mc(uC+i*w,xC+i*w+w,(xn-i-1)*w);Y(xtA,u=sqz(mRa(u)))x(u))
 et2(x,y))
A1(enl,P(xtl||xtd,AT(tT(xt),x))P(xtc||xtz||xts,atnv(tT(xt),1,&x))Xm(Ay=kv(&x);aM(x,ea1(enl,y)))a1(x))
A1(enla,Xmt(enl(x))x)
A2(cat,
 P(xtmM&&ytmM,P(xtm&&ytm,Az=kv(&y);amd(A(x,y,av0,z),4))Ed(!mtc_(xx,yx),x,y)
              Au=eac(cv(','),A(mR(xy),mR(yy)),2);Y(u,u=aM(mR(xx),u))x(y(u)))
 x=enla(x);P(!xn,x(enla(y)))P(ytT&&!yn,y(x))Y(xtZ&&ytzZ,N(sup(&x,&y)))
 y=enla(y);Y(xt-yt,x=blw(x);y=blw(y))L w=ZT[xt],m=xn,n=yn;Au;
 Y(xr==1&&(m+n)*w<=cap(x),u=AN(m+n,x))E(u=atn(xt,m+n);mc(uC,xC,m*w);Y(xtA,Y(xr==1,AN(0,x))E(mRa(x)))x(0))
 mc(uC+m*w,yC,n*w);Y(ytA,mRa(y))y(u))
A apv(Ax,OV*v)_(Q(xtT);Nn=xn,w=ZT[xt];
 Y(xr==1&&w+n*w<=cap(x),x=AN(n+1,x))
 E(Ay=atn(xt,n+1);Y(xr>1&&xtA,mRa(x))EY(xtR,x=AT(tL,x))m2(x,mc(yC,xC,n*w));x=y)
 V*p=xC+n*w;mc(p,v,w);x)
A2(apd,Q(xtT||xtM);XM(P(!ytm||!mtc_(xx,yx),apd(Ny(blw(x)),y))x=mut(x);Az=xy=mut(xy);i(zn,_q(za,get(yy,i)))y(x))
 Y(xtZ&&ytz,A1*f=ct[max(xt,yt-tl+tL)];x=Ny(f(x));y=Nx(f(y)))
 P(!xtA&&(!ytt||xt-tT(yt)),cat(x,enl(y)))P(!xn,enl(x(y)))Lv=xtA?(L)y:gl(y);apv(x,&v))
A apc(Ax,Cc)_(Q(xtC);x=room(x,1);xC[xn]=c;AN(xn+1,x))A catc(Ax,OC*s,Nn)_(Q(xtC);x=room(x,n);mc(xC+xn,s,n);AN(xn+n,x))
