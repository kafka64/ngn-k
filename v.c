#include"a.h" // ngn/k, (c) 2019-2020 ngn, GNU AGPLv3 - https://bitbucket.org/ngn/k/raw/master/LICENSE
#define til_(T)              V til##T(T*a,U##T n)_(ALN(a)F(PAD(n,a),a[i]=i))
#define rev_(T)            S V rev##T(T*a,UL n)_(T*b=a+n-1;W(a<b,SWP(*a,*b);a++;b--))
#define c__(Ta,Tr,pd)      S V c##Ta##Tr(O Ta*RE a,Tr*RE r,UL n)_(F(PAD(n,pd),r[i]=a[i]))
#define cN(Ta,Tr,pd,Na,Nr) S V c##Ta##Tr(O Ta*RE a,Tr*RE r,UL n)_(F(PAD(n,pd),r[i]=a[i]==Na?Nr:a[i]))
til_(L)til_(I)til_(H)rev_(C)rev_(I)rev_(L)
c__(C,I,r)c__(I,C,a)c__(L,C,a)cN(I,L,r,_0Ni,_0Nl)cN(L,I,a,_0Nl,_0Ni)cN(L,D,a,_0Nl,_0n)cN(D,L,a,_0n,_0Nl)
A1(flp,P(xtmM,Y(xtm,A y=xy;er(!ytA||!yn,x)F(yn,A z=yai;en(!ztT,x))L m=An(*ya);F(yn,A z=yai;el(zn-m,x)))AT(xt^tm^tM,x))P(xtt,enl(enl(x)))
 P(!xtA||!xn,enl(x))K("{(,/n#'x)(n*!#x)+/:!n:|/#'x}",x))
A1(til,P(xti,I n=gi(x);I m=n<0;n*=1-2*m;A u=aI(n);tilI(ui,n);m?sub(u,ai(n)):u)
       P(xtl,L n=gl(x);I m=n<0;n*=1-2*m;A u=aL(n);tilL(ul,n);m?sub(u,al(n)):u)
       P(xtIL,K("{x((*a)#&#)'1_a:|*\\|x,1}",x))P(xtm,fir(AT(tA,x)))P(xto,val(x))et(!xtA||xn,x)x)
A1(whr,et(xtM||xtA,x)P(xtm,A y=gkv(&x);idx(x,Nx(whr(y))))x=N(gL(enla(x)));L n=0;F(xn,ed(xli<0,x)n+=xli)A u=aL(n);m2(x,n=0;F(xn,Fj(xli,ul[n++]=i))u))
A1(rev,P(xtt,x)P(xtm,AT(tm,N(ea1(rev,AT(tA,x)))))P(xtM,A y=gkv(&x);aM(x,Nx(ea1(rev,y))))
 x=mut(x);I w=ZT[xt];w==1?revC(xc,xn):w==4?revI(xi,xn):revL(xl,xn);x)
A1(typ,C t=xt;xr;as(syC(C(TS)[t])))A1(len,dex(x,al(len_(x))))L len_(A x/*0*/)_(xtT?xn:xtm?len_(xy):!xtM?1:An(xy)?len_(*(A*)dat(xy)):1)
A1(unq,et(!xtT,x)xn<2?x:K("{x@&@[&#x;i;:;]@[;0;:;a=a:*a]@a:~$[`A=@x;~;=]':x@i:<x}",x))
S A2(fil,ytmMA?eac(cv('^'),A(x,y),2):ytt?fir(xpt(x,enl(y))):K("{@[y;&^y;:;x]}",x,y))
A2(xpt,P(xtt,fil(x,y))en(xtmM||ytmM,x,y)y=enla(y);Y(xtA,y=blw(y))K("{x@&^y?x}",x,y))
A2(cut,P(ytil,et(!xtT,x,y)L i=gl(y);P(!in(i,xn),x)A u=atn(xt,xn-1);L w=ZT[xt];mc(uc,xc,i*w);mc(uc+i*w,xc+i*w+w,(xn-i-1)*w);Y(xtA,u=sqz(mRa(u)))xr;u)
 P(ytm,rsh(xpt(mR(yx),x),y))et(ytt,x,y)x=Ny(gL(x));K("{n:#y;y$[`l=@x;$[n<x|-x;!0;x<0;!n+x;x+!n-x];x+!'1_-':x,#y]}",x,y))
S A gt(A x,A1*f)_(fir(N(f(enl(x)))))
A1(gC,P(xtcC,x)P(xtt,gt(x,gC))x=N(gI(x));A u=aC(xn);m2(x,cIC(xi,uc,un);u))
A1(gI,P(xtiI,x)P(xtdD,gI(N(gL(x))))P(xtl,gt(x,gI))P(xtL,A u=aI(xn);m2(x,cLI(xl,ui,un);u))P(xtc,ai(gc(x)))et(!xtC,x)A u=aI(xn);m2(x,cCI(xc,ui,un);u))
A1(gL,P(xtlL,x)P(xtt,gt(x,gL))P(xtD,A u=aL(xn);m2(x,cDL(xd,ul,un);u))x=N(gI(x));A u=aL(xn);m2(x,cIL(xi,ul,un);u))
A1(gD,P(xtdD,x)P(xtt,gt(x,gD))x=N(gL(x));A u=aD(xn);m2(x,cLD(xl,ud,un);u))
A1(gS,P(xtsS,x)P(xtC,x=str0(x);dex(x,as(syP(xc))))et(!xtc,x)as(syC(gc(x))))
A2(cst,P(ytmMA,eac(cv('$'),A(x,y),2))P(xtil&&ytC,ap1(y,Ny(til(x))))en(!xts,x,y)
 I i=gI(K("``s`c`i`l`j`d`f?",x));ed(i<0,y)(A1*[]){gS,gS,gC,gI,gL,gL,gD,gD}[i](y))
A1(sqz,P(!xtA||!xn,x)A y=xx;C t=yt;P(!sim(y)&&t-tm,x)L n=xn;F(n,A y=xai;P(t-yt,x))P(t==tm,A z=yx;F(n,A y=xai;P(!mtc_(yx,z),x))aM(zR,flp(ea1(val,x))))
 t=t_lst(t);A u=atn(t,n);I w=ZT[t];asrt(!reft(t));P(w==1,m2(x,cLC(xl,uc,n);u))P(w==4,m2(x,cLI(xl,ui,n);u))asrt(w==8);F(n,A y=xai;uli=*yl);xr;u)
A1(blw,P(xtA,x)P(xtt,a1(x))et(xtm,x)L n=len_(x);A u=aA(n);F(n,uai=get(x,i))xr;u)
L tru(A x/*1*/)_(L r=sim(x)?gl_(x):fun(x)?!xtu||xv:xn;xr;r)A2(dex,xr;y)A1(fir,xtt?x:dex(x,getr(x,0)))A1(las,xtt?x:dex(x,getr(x,xn-1)))
