#include"k.h" // ngn/k, (c) 2019-2020 ngn, GNU AGPLv3 - https://bitbucket.org/ngn/k/raw/master/LICENSE
A1(sqz,P(!xtX||!xn,x)A y=xx;UC t=yt;P(!sim(y)&&t-ta,x)L n=xn;F(n,A y=xai;P(t-yt,x))
 P(t==ta,A z=yx;F(n,A y=xai;P(!mtc_(yx,z),x))aA(zR,flp(ea1(val,x))))
 t=t_lst(t);A u=atn(t,n);
 Y(t==tC,F(n,uci=gc(xai)))EY(t==tS,F(n,uii=gs(xai)))EY(t==tI,F(n,uii=gi(xai)))EY(t==tL,F(n,uli=gl_(xai)))EY(t==tD,F(n,udi=gd_(xai)))E(UR)xr;u)
A1(blw,P(xtX,x)P(xtt,a1(x))P(xta,et(x))L n=len_(x);A u=aX(n);F(n,uai=get(x,i))xr;u)
L tru(A x/*1*/)_(L r=sim(x)?gl_(x):fun(x)?!xtu||xv:xn;xr;r)A2(dex,xr;y)A1(fir,xtt?x:dex(x,getr(x,0)))A1(las,xtt?x:dex(x,getr(x,xn-1)))
A1(flp,P(xtaA,Y(xta,A y=xy;P(!ytX||!yn,er(x))F(yn,A z=yai;P(!ztT,en(x)))L m=An(*ya);F(yn,A z=yai;P(zn-m,el(x))))AT(xt^ta^tA,x))P(xtt,enl(enl(x)))
 P(!xtX||!xn,enl(x))K("{(,/n#'x)(n*!#x)+/:!n:|/#'x}",x))
A till(L n)_(A x=aL(n);F(n,xli=i)x)
A tili(I n)_(A x=aI(n);F(n,xii=i)x)
A1(til,P(xti,I n=gi(x);n<0?add(ai(n),N(tili(-n))):tili(n))
       P(xtl,L n=gl(x);n<0?add(al(n),N(till(-n))):till(n))
       xtIL?K("{x((*a)#&#)'1_a:|*\\|x,1}",x):xta?fir(AT(tX,x)):xto?val(x):xtX&&!xn?x:et(x))
A1(whr,P(xtA||xtX,et(x))P(xta,A y=gkv(&x);idx(x,Nx(whr(y))))
 x=N(gL(enla(x)));L n=0;F(xn,P(xli<0,ed(x))n+=xli)A u=aL(n);mr2(x,n=0;F(xn,Fj(xli,ul[n++]=i))u))
A1(rev,P(xtt,x)P(xta,AT(ta,N(ea1(rev,AT(tX,x)))))P(xtA,A y=gkv(&x);aA(x,Nx(ea1(rev,y))))
 x=mut(x);L j=xn,m=(xn+1)/2;I w=tZ(xt);P(w==1,F(m,--j;SWP(xci,xcj))x)
                                       P(w==4,F(m,--j;SWP(xii,xij))x)
                                       P(w==8,F(m,--j;SWP(xli,xlj))x)UR;0)
A1(typ,S O UC s[]={TS};UC t=xt;xr;as(s[t]))A1(len,dex(x,al(len_(x))))L len_(A x/*0*/)_(xtT?xn:xta?len_(xy):!xtA?1:An(xy)?len_(*(A*)dat(xy)):1)
A1(unq,P(!xtT,et(x))P(xn<2,x)P(ref(x),A u=atn(xt,0);F(xn,fpa(&u,mR(xai)))xr;u)K("{x@&@[&#x;i;:;]@[;0;:;a=a:*a]@a:~=':x@i:<x}",x))
S A2(fil,ytaAX?eac(cv('^'),A_(x,y),2):ytt?fir(xpt(x,enl(y))):K("{@[y;&^y;:;x]}",x,y))
A2(xpt,P(xtt,fil(x,y))P(xtaA||ytaA,en(x,y))y=enla(y);Y(xtX,y=blw(y))K("{x@&^y?x}",x,y))
A2(cut,
 P(ytil,P(!xtT,et(x,y))L i=gl(gL(y));P(!in(i,xn),x)A u=atn(xt,xn-1);L w=tZ(xt);mc(uc,xc,i*w);mc(uc+i*w,xc+i*w+w,(xn-i-1)*w);Y(xtX,u=sqz(mRa(u)))xr;u)
 P(yta,rsh(xpt(mR(yx),x),y))P(ytt,et(x,y))x=Ny(gL(x));K("{n:#y;y$[`l=@x;$[n<x|-x;!0;x<0;!n+x;x+!n-x];x+!'1_-':x,#y]}",x,y))
S L gLI(I i)_(i-_0Ni?i:_0Nl)S I gIL(L l)_(l-_0Nl?l:_0Ni)S D gDL(L l)_(l-_0Nl?(D)l:_0n)
A1(gL,P(xtlL,x)P(xtd,al((L)gd(x)))P(xtD,A u=aL(xn);F(un,uli=(L)xdi)xr;u)x=N(gI(x));P(xtt,al(gLI(gi(x))))A u=aL(xn);F(un,uli=gLI(xii))xr;u)
S A1(gC,P(xtcC,x)x=N(gI(x));P(xtt,ac(gLI(gi(x))))A u=aC(xn);F(un,uci=xii)xr;u)
A1(gD,P(xtdD,x)x=N(gL(x));P(xtt,ad(gDL(gl(x))))A u=aD(xn);F(un,udi=gDL(xli))xr;u)
A1(gI,P(xtiI,x)P(xtdD,gI(gL(x)))P(xtl,ai(gIL(gl(x))))P(xtL,A u=aI(xn);F(un,uii=gIL(xli))xr;u)P(xtc,ai(gc(x)))P(xtC,A u=aI(xn);F(un,uii=(UC)xci)xr;u)et(x))
A1(gS,P(xtsS,x)P(xtC,x=str0(x);dex(x,as(syP(xc))))P(xtc,as(Q(gc(x))))et(x))
A2(cst,P(ytaAX,eac(cv('$'),A_(x,y),2))P(xtil&&ytcC,ap1(y,Ny(til(x))))
 P(xts,I v=gs(x);A1*f=!v||v==Qs?gS:v==Qc?gC:v==Qi?gI:v==Ql||v==Qj?gL:v==Qd||v==Qf?gD:0;f?f(y):ed(y))en(x,y))
